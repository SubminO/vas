<script>
    $(function () {
        $.ajaxSetup({
            headers: {"X-CSRFToken": getCookie("csrftoken")}
        });

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) c_end = document.cookie.length;
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }

        $('.ajax_form').click(function () {
            $('.ajax-body').hide();

            var lat = 55.747571;
            var lng = 37.628141;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }

            function showPosition(position) {
                {#TODO: Отключен вывод по геолокации#}
                lat = position.coords.latitude;
                lng = position.coords.longitude;
            }

            $.ajax({
                method: "POST",
                url: "{% url 'admin_panel_ajax_add' %}",
                {#data: form.serialize()#}
            })
                .done(function (msg) {
                        {#$('#myModal').modal();#}
                        $('.ajax-body').html(msg);

                        var mymap = L.map('mapid').setView([lat, lng], 10);

                        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                            maxZoom: 18,
                            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                            id: 'mapbox.streets'
                        }).addTo(mymap);

                        var marker;
                        mymap.on('click', function (ev) {
                            if (marker) { // check
                                mymap.removeLayer(marker); // remove
                            }
                            marker = new L.marker(ev.latlng); // set
                            marker.addTo(mymap);
                            $("#id_latitude").val(ev.latlng.lat);
                            $("#id_longitude").val(ev.latlng.lng);
                        });
                        $('.ajax-body').show(300);
                        setTimeout(function () {
                            mymap.invalidateSize();
                        }, 350);
                        {#$('.ajax_overlay').addClass('d-none');#}
                        {#var phoneMask = new IMask(#}
                        {#    document.getElementById('id_phone'), {#}
                        {#        mask: '+{7}(000)000-00-00'#}
                        {#    });#}
                    }
                );
        });

    });
</script>